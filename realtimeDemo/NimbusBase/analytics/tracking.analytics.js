// Generated by CoffeeScript 1.6.3
(function() {
  var baseUrl;

  baseUrl = "http://www.google-analytics.com/collect?v=1&tid=UA-46950334-1&cid=001";

  Nimbus.track.google = {
    data: {
      page_url: "",
      app_name: "",
      cloudType: "",
      email: ""
    },
    send_page_tracking: function(url) {
      var path, xhr;
      path = baseUrl + "&t=pageview&dp=" + encodeURI(url);
      xhr = new XMLHttpRequest();
      xhr.open("GET", path, true);
      xhr.send(null);
    },
    send_event_tracking: function(dom, action, id, value) {
      var path, xhr;
      if (dom == null) {
        dom = 0;
      }
      if (action == null) {
        action = 0;
      }
      if (id == null) {
        id = 0;
      }
      if (value == null) {
        value = 0;
      }
      path = baseUrl + "&t=event&ec=" + encodeURI(dom) + "&ea=" + encodeURI(action) + "&el=" + encodeURI(id) + "&ev=" + encodeURI(value);
      xhr = new XMLHttpRequest();
      xhr.open("GET", path, true);
      return xhr.send(null);
    },
    registered_user: function() {
      this.data["page_url"] = window.location.href;
      this.data["app_name"] = Nimbus.Auth.app_name;
      this.data["cloudType"] = Nimbus.Auth.service;
      this.send_page_tracking(this.data.page_url);
      setTimeout(function() {
        var count, data, i, len;
        count = 0;
        for (i in Nimbus.dictModel) {
          len = Nimbus.dictModel[i].all().length;
          count = count + len;
        }
        Nimbus.track.google.data["sum"] = count;
        data = Nimbus.track.google.data;
        log("send to gogole analytic :", data);
        Nimbus.track.google.send_event_tracking(data.app_name, data.email, data.cloudType, data.sum);
      }, 15000);
      if (Nimbus.Auth.service === "Dropbox") {
        Nimbus.Client.Dropbox.getAccountInfo(function(info) {
          if (info.email != null) {
            return Nimbus.track.google.data["email"] = info.email;
          }
        });
      }
      if (Nimbus.Auth.service === "GDrive") {
        return Nimbus.track.google.data["email"] = Nimbus.Client.GDrive.get_user_email();
      }
    }
  };

  window.onerror = function(msg, url, line) {
    var error, info;
    error = {
      email: Nimbus.track.google.data.email,
      app_name: Nimbus.track.google.data.app_name,
      cloudType: Nimbus.track.google.data.cloudType,
      line_: line,
      url_: url,
      msg_: msg
    };
    info = JSON.stringify(error);
    log("got error, send to  google analytic:", encodeURI(info));
    return Nimbus.track.google.send_event_tracking(error.app_name, "error", encodeURI(info));
  };

}).call(this);
